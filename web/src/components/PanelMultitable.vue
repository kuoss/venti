<script setup>
import { useDatasourceStore } from '@/stores/datasource';
</script>

<script>
export default {
  props: {
    count: Number,
    isLoading: Boolean,
    panelConfig: Object,
    panelWidth: Number,
    timeRange: Object,
  },
  data() {
    return {
      rows: [],
      datasources: [],
    };
  },
  watch: {
    count() {
      if (!this.loading) this.fetchData();
    },
  },
  mounted() {
    this.fetchDatasources();
  },
  methods: {
    async fetchDatasources() {
      // try {
      //   const response = await fetch('/api/v1/datasources');
      //   const jsonData = await response.json();
      //   this.datasources = jsonData;
      // } catch (error) {
      //   console.error(error);
      // }
      this.datasources = await useDatasourceStore().getDatasources();
      this.fetchData();
    },
    async fetchData() {
      if (this.timeRange.length < 2) return;
      this.$emit('setIsLoading', true);
      try {
        let rows = [];
        for (let i = 0; i < this.datasources.length; i++) {
          const ds = this.datasources[i];
          if (ds.type != 'prometheus' || !ds.isDiscovered) continue;

          let row = [ds.name];
          for (const target of this.panelConfig.targets) {
            const response = await fetch(
              '/api/v1/remote/query?' + new URLSearchParams({ dsid: i, query: target.expr, time: this.timeRange[1] }),
            );
            const jsonData = await response.json();
            const result = jsonData.data.result;
            if (!('legends' in target)) {
              row.push(result[0]?.value[1] ?? '-');
              continue;
            }
            for (const legend of target.legends) {
              const value = result.map(x => legend.replace(/\{\{(.*?)\}\}/g, (i, m) => x.metric[m]))[0];
              row.push(value ?? '-');
            }
          }
          rows.push(row);
        }
        console.log(rows);
        this.rows = rows;
      } catch (error) {
        console.error(error);
      }
      this.$emit('setIsLoading', false);
    },
  },
};
</script>

<template>
  <table class="w-full border-collapse">
    <tr class="border-b">
      <th v-for="h in panelConfig.headers" class="px-2 py-1 bg-slate-50">
        {{ h }}
      </th>
    </tr>
    <tr v-for="row in rows" class="border-b">
      <td v-for="cell in row" class="border-l px-2 py-1" :class="{ 'text-right': !isNaN(cell) }">
        {{ cell }}
      </td>
    </tr>
  </table>
</template>
